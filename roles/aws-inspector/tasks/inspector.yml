---
# tasks file for mediapeers.aws-inspector

#- name: Make sure system dependencies are met (libcurl3)
#  yum:
#    name: libcurl
#    state: present

- name: Create workspace Folder
  become: yes
  become_method: sudo
  become_user: root
  file:
   path=/workspace/
   owner=user
   group=user
   mode=0755
   state=directory

- name: Download aws inspector agent installation script
  get_url:
    url: "{{ install_script_url }}"
    dest: "/workspace/aws-inspector-agent-install"

- name: Execute the agent installer
  become: yes
  shell: bash workspace/aws-inspector-agent-install

- name: Enable awsagent on bootup
  service:
    name: awsagent
    enabled: yes

- name: Get agent status
  become: yes
  shell: '/opt/aws/awsagent/bin/awsagent status'
  register: aws_agent_status

- name: Output awsagent status
  debug:
    var: aws_agent_status.stdout

- name: Cleanup install script
  file:
    name: /workspace/aws-inspector-agent-install
    state: absent
